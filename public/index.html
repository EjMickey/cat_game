<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Multiplayer Koty</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #f0f0f0;
        }
        canvas {
            display: block;
            background: #a0e7e5;
        }
        #chat {
            position: absolute;
            top: 10px;
            left: 1020px;
            width: 300px;
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        #messages {
            list-style-type: none;
            padding: 0;
            margin: 0;
            max-height: 150px;
            overflow-y: auto;
        }
        #chat-input {
            width: calc(100% - 60px);
            padding: 5px;
        }
        button {
            padding: 5px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
<div style="display:none;">
    <img id="enemy" width="220" height="277" src="img/cat_enemy.jpg">
</div>
<div style="display:none;">
    <img id="player" width="220" height="277" src="img/cat_player.png">
</div>
<canvas id="gameCanvas" width="1000" height="600"></canvas>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const players = {};
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const chatForm = document.createElement('form');
    const chatInput = document.createElement('input');
    const chatButton = document.createElement('button');
    const messagesList = document.createElement('ul');
    const chatDiv = document.createElement('div');

    chatForm.id = 'chat-form';
    chatInput.id = 'chat-input';
    chatButton.textContent = 'WyÅ›lij';
    chatButton.type = 'submit';
    chatDiv.id = 'chat';
    messagesList.id = 'messages';

    chatForm.appendChild(chatInput);
    chatForm.appendChild(chatButton);
    chatDiv.appendChild(messagesList);
    chatDiv.appendChild(chatForm);
    document.body.appendChild(chatDiv);

    socket.on('currentPlayers', (serverPlayers) => {
        Object.assign(players, serverPlayers);
    });

    socket.on('newPlayer', (playerData) => {
        players[playerData.id] = playerData;
    });

    socket.on('playerMoved', (playerData) => {
        if (players[playerData.id]) {
            players[playerData.id].x = playerData.x;
            players[playerData.id].y = playerData.y;
        }
    });

    socket.on('playerHurt', (playerData) => {
        if (players[playerData.id]) {
            players[playerData.id].hp = playerData.hp;
            players[playerData.id].exp = playerData.exp;
        }
    });

    socket.on('playerLvled', (playerData) => {
        if (players[playerData.id]) {
            players[playerData.id].lvl = playerData.lvl;
        }
    });

    socket.on('playerDisconnected', (id) => {
        delete players[id];
    });

    socket.on('chat message', (msg) => {
        const item = document.createElement('li');
        item.textContent = msg;
        messagesList.appendChild(item);
    });

    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (chatInput.value) {
            socket.emit('chat message', chatInput.value);
            chatInput.value = '';
        }
    });

    const keys = {};

    window.addEventListener('keydown', (e) => {
        keys[e.key] = true;
    });

    window.addEventListener('keyup', (e) => {
        keys[e.key] = false;
    });

    function sendMovement() {
        let movement = { x: 0, y: 0 };
        if (keys['ArrowUp']) movement.y = -1;
        if (keys['ArrowDown']) movement.y = 1;
        if (keys['ArrowLeft']) movement.x = -1;
        if (keys['ArrowRight']) movement.x = 1;
        socket.emit('move', movement);
    }

    function gameLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        for (const id in players) {
            const player = players[id];
            if (!player) continue;

            const img = id === socket.id ? document.getElementById('player') : document.getElementById('enemy');
            ctx.drawImage(img, player.x, player.y)
            ctx.fillStyle = 'black';
            ctx.font = '14px Arial';
            ctx.fillText(`HP: ${player.hp} EXP: ${player.exp}`, player.x, player.y - 10);
            ctx.fillText(`LVL: ${player.lvl}`, player.x, player.y + 70);
        }

        sendMovement();

        requestAnimationFrame(gameLoop);
    }

    gameLoop();
</script>
</body>
</html>
