<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Multiplayer Koty</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #f0f0f0;
        }
        canvas {
            display: block;
            background: #a0e7e5;
        }
        #chat {
            position: absolute;
            top: 10px;
            left: 1020px;
            width: 300px;
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        #messages {
            list-style-type: none;
            padding: 0;
            margin: 0;
            max-height: 200px;
            overflow-y: auto;
        }
        #chat-input {
            width: calc(100% - 60px);
            padding: 5px;
        }
        button {
            padding: 5px;
            margin-left: 5px;
        }
        .avatar-option {
            display: inline-block;
            margin: 10px;
            cursor: pointer;
            text-align: center;
          }
        
          .avatar-option input[type="radio"] {
            display: none;
          }
        
          .avatar-option img {
            width: 80px;
            height: 80px;
            border: 2px solid transparent;
            border-radius: 10px;
            transition: 0.3s;
          }
        
          .avatar-option input[type="radio"]:checked + img {
            border-color: #007bff;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
          }
    </style>
</head>
<body>
<div style="display:none;">
    <img id="banana" width="50" height="50" src="img/banana.png">
</div>
<div style="display:none;">
    <img id="garf" width="50" height="50" src="img/garf.png">
</div>
<div style="display:none;">
    <img id="gaze" width="50" height="50" src="img/gaze.png">
</div>
<div style="display:none;">
    <img id="huh" width="50" height="50" src="img/huh.png">
</div>

<div id="start-screen" style="
    position: absolute;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
">
    <form id="player-form" style="background: white; padding: 20px; border-radius: 10px;">
        <label>ImiÄ™: <input type="text" id="player-name" required minlength="1" maxlength="16"/></label><br><br>

        <label>Kolor kota: 
            <input type="color" id="cat-color" value="#ff8800" />
        </label><br><br>

        <label>Flaga kraju:
            <select id="player-flag">
                <option value="pl">ðŸ‡µðŸ‡± Polska</option>
                <option value="us">ðŸ‡ºðŸ‡¸ USA</option>
                <option value="de">ðŸ‡©ðŸ‡ª Niemcy</option>
                <option value="fr">ðŸ‡«ðŸ‡· Francja</option>
                <option value="jp">ðŸ‡¯ðŸ‡µ Japonia</option>
            </select>
        </label><br><br>

        <label class="avatar-option">
            <input type="radio" name="avatar" value="banana">
            <img src="img/banana.png" alt="Banana">
          </label>
        
          <label class="avatar-option">
            <input type="radio" name="avatar" value="garf">
            <img src="img/garf.png" alt="Garf">
          </label>
        
          <label class="avatar-option">
            <input type="radio" name="avatar" value="gaze">
            <img src="img/gaze.png" alt="Gaze">
          </label>

          <label class="avatar-option">
            <input type="radio" name="avatar" value="huh">
            <img src="img/huh.png" alt="Huh">
          </label>
        </br>
        <button type="submit">DoÅ‚Ä…cz do gry</button>
    </form>
</div>

<canvas id="gameCanvas" width="1000" height="600"></canvas>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let players = {};
    let weapons = [];
    let first_aids = [];
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const chatForm = document.createElement('form');
    const chatInput = document.createElement('input');
    const chatButton = document.createElement('button');
    const messagesList = document.createElement('ul');
    const chatDiv = document.createElement('div');
    const startScreen = document.getElementById('start-screen');
    const playerForm = document.getElementById('player-form');
    const playerNameInput = document.getElementById('player-name');


    chatForm.id = 'chat-form';
    chatInput.id = 'chat-input';
    chatButton.textContent = 'WyÅ›lij';
    chatButton.type = 'submit';
    chatDiv.id = 'chat';
    messagesList.id = 'messages';

    chatForm.appendChild(chatInput);
    chatForm.appendChild(chatButton);
    chatDiv.appendChild(messagesList);
    chatDiv.appendChild(chatForm);
    document.body.appendChild(chatDiv);

    playerForm.addEventListener('submit', (e) => {
        e.preventDefault();
    
        const name = playerNameInput.value.trim();
        const color = document.getElementById('cat-color').value;
        const flag = document.getElementById('player-flag').value;
        const avatar = document.querySelector('input[name="avatar"]:checked')?.value;
        if (name.length >= 1 && name.length <= 16) {
            socket.emit('join_request', { name, color, flag, avatar });
        }
    });
    
    socket.on('join_accepted', (playerData) => {
        startScreen.style.display = 'none';
        players[socket.id] = playerData;
    });

    let click = {x: undefined, y:undefined}

    socket.on('currentPlayers', (serverPlayers) => {
        Object.assign(players, serverPlayers);
    });

    socket.on('newPlayer', (playerData) => {
        players[playerData.id] = playerData;
    });

    socket.on('players_update', (playerData) => {
        players = playerData.players
    });

    socket.on('playerDisconnected', (id) => {
        delete players[id];
    });

    socket.on('chat message', (msg) => {
        const item = document.createElement('li');
        item.textContent = msg;
        messagesList.appendChild(item);
        const chatBox = document.getElementById('messages');
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    socket.on('power_ups', (data) => {
        first_aids = data.first_aids;
        weapons = data.weapons
    });

    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (chatInput.value) {
            message = 
            socket.emit('chat message', chatInput.value);
            chatInput.value = '';
        }
    });

    const keys = {};

    window.addEventListener('keydown', (e) => {
        keys[e.key] = true;
    });

    window.addEventListener('keyup', (e) => {
        keys[e.key] = false;
    });

    function sendMovement() {
        let movement = { x: 0, y: 0 };

        if (keys['ArrowUp'] || keys['w']) movement.y = -1;
        if (keys['ArrowDown'] || keys['s']) movement.y = 1;
        if (keys['ArrowLeft'] || keys['a']) movement.x = -1;
        if (keys['ArrowRight'] || keys['d']) movement.x = 1;

        socket.emit('move', movement);
    }

    function setClick(){
        click.x = event.clientX 
        click.y = event.clientY
    }

    /*
    function moveTowardPoint(player) {
        let movement = { x: 0, y: 0 };
        if(Math.abs(click.y-(player.y+25)) <= 3) { 
            movement.y=0 
            click.y = undefined 
        }
        if(Math.abs(click.x-(player.x+25)) <= 3) { 
            movement.x=0 
            click.x = undefined 
        }
        if(click.x != undefined){
            if(click.x > player.x+25) { movement.x=1 }
            else {movement.x=-1}
        }
        if(click.y != undefined){
            if(click.y > player.y+25) { movement.y=1 }
            else {movement.y=-1}
        }
        console.log(click, player)
        socket.emit('move', movement);
      }
      
    document.addEventListener("click", setClick);*/

    function gameLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        for (const id in players) {
            const player = players[id];
            if (!player) continue;

            const img = document.getElementById(player.avatar)
            ctx.drawImage(img, player.x - 25, player.y - 25);

            // ObwÃ³dka kolorem gracza
            ctx.fillStyle = player.color || 'black';
            ctx.font = '15px Arial'; 
            ctx.globalAlpha = 1; // przezroczystoÅ›Ä‡ koloru
            ctx.lineWidth = 1;
            // Flaga
            const flagMap = {
                pl: 'ðŸ‡µðŸ‡±',
                us: 'ðŸ‡ºðŸ‡¸',
                de: 'ðŸ‡©ðŸ‡ª',
                fr: 'ðŸ‡«ðŸ‡·',
                jp: 'ðŸ‡¯ðŸ‡µ'
            };
            
            const flagEmoji = flagMap[player.flag?.toLowerCase()] || '';
            //ctx.fillText(flagEmoji, player.x - 10, player.y - 30);

            
            let hp_bar = '['
            for(let i=0;i<10;i++){
                if(player.max_hp*i/10 < player.hp){
                    hp_bar+= '|'
                }
                else{
                    hp_bar += ' '
                }
            }
            hp_bar += ']'
            ctx.fillText(`${hp_bar} [${player.lvl}]`, player.x-30, player.y + 45 );
            //ctx.strokeText(`${hp_bar} [${player.lvl}]`, player.x-35, player.y + 45 );
            ctx.fillText(`${player.name} `, player.x-(player.name.length*4), player.y- 35);
            //ctx.strokeText(`${player.name} `, player.x-40, player.y- 35);
            //ctx.globalAlpha = 1.0;
            ctx.strokeStyle = 'black';

            if(player.armed){
                ctx.beginPath();
                ctx.lineWidth = "3";
                ctx.strokeStyle = "red";
                ctx.rect(player.x-25, player.y-25, 50, 50);
                ctx.stroke();
                ctx.strokeStyle = "black";
                ctx.lineWidth = "1";
            }
            //moveTowardPoint(player)
        }

        for(const first_aid of first_aids){
            ctx.beginPath();
            ctx.arc(first_aid.x, first_aid.y, 5, 0, 2 * Math.PI);
            ctx.fillStyle = "green";
            ctx.fill();
            ctx.stroke();
        }
        for(const weapon of weapons){
            ctx.beginPath();
            ctx.arc(weapon.x, weapon.y, 5, 0, 2 * Math.PI);
            ctx.fillStyle = "red";
            ctx.fill();
            ctx.stroke();
        }
        requestAnimationFrame(gameLoop);
    }

    gameLoop();

    setInterval(() => {
        sendMovement();
    }, 16)
</script>
</body>
</html>
